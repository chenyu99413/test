<?php
require_once _INDEX_DIR_ . '/_code/helper/PDFMerger/fpdf/fpdf.php';
require_once _INDEX_DIR_ . '/_code/helper/PDFMerger/fpdf/chinese.php';
/**
 * 后台服务控制器
 *
 */
class Controller_Cron extends Controller_Abstract{
    /**
     * notifyBizEvent
     */
    function actionnotifyBizEvent(){
        $url_sign='https://gw.open.1688.com/openapi/param2/1/ali.intl.onetouch/logistics.order.notifyBizEvent/563333';
       	$events=Event::find("ifnull(send_flag,'')!='1' and send_times< 2 and order_id>'82' and confirm_flag = '1' and ifnull(reason,'')=''  and event_time<=?",time())->order('order_id,event_time')->getAll();
        foreach ($events as $event){
            $ali_order_no=Order::find('order_id=?',$event->order_id)->getOne();
            if(strtoupper(substr($ali_order_no->ali_order_no,0,3))!='ALS'){
               continue;
            }
            $ali=new Helper_ALI();
            $event_request_data=$ali->notifyBizEvent($event);
            $sign=$ali->sign($url_sign, json_encode($event_request_data),'notifyBizEvent');
            //组合完整url
            QLog::log($url_sign.'?notifyBizEventDTO='.json_encode($event_request_data).'&_aop_signature='.$sign);
            $url=$url_sign.'?notifyBizEventDTO='.urlencode(json_encode($event_request_data)).'&_aop_signature='.$sign;
            QLog::log($url);
            //通过curl get 方式发送至阿里
            $response=Helper_Curl::get1($url);
            QLog::log('event_response'.$response);
            $response=json_decode($response,true);
            if(isset($response['success']) && $response['success']==true){
                $event->send_flag='1';
                $event->save();
                if($event->event_code=='DELIVERY'){
	                	$order=Order::find('order_id=?',$event->order_id)->getOne();
	                	$order->delivery_time=$event->event_time;
	                	$order->order_status='9';
	                	$order->save();
                }
            }else{
            	$event->send_times=$event->send_times+1;
            	$event->save();
            	$order=Order::find('order_id=?',$event->order_id)->getOne();
                $email_response=Helper_Mailer::send('986502672@qq.com', '发送事件失败', '阿里单号 '.$order->ali_order_no.',失败原因：'.json_encode($response));
                $email_response=Helper_Mailer::send('bbop@far800.com', '紧急！阿里事件发送失败！', '阿里单号 '.$order->ali_order_no.',失败原因：'.json_encode($response));
                $email_response=Helper_Mailer::send('liujian@far800.com', '紧急！阿里事件发送失败！', '阿里单号 '.$order->ali_order_no.',失败原因：'.json_encode($response));
            }
        }
        exit();
    }
    /**
     * notifyTrace
     */
    function actionnotifyTrace(){
        $url_sign='https://gw.open.1688.com/openapi/param2/1/ali.intl.onetouch/logistics.order.notifyTrace/563333';
        $tracking=Tracking::find("ifnull(send_flag,'')!='1' and send_times< 2 and order_id>'82' and confirm_flag = '1' and trace_time<=?",time())->getAll();
        foreach ($tracking as $temp){
        	$order=Order::find('order_id=?',$temp->order_id)->getOne();
        	if(strtoupper(substr($order->ali_order_no,0,3))!='ALS'){
        	    continue;
        	}
            $ali=new Helper_ALI();
            $trace_request_data=$ali->notifyTrace($temp);
            $sign=$ali->sign($url_sign, json_encode($trace_request_data),'notifyTrace');
            //组合完整url
            $url=$url_sign.'?notifyTraceDTO='.urlencode(json_encode($trace_request_data)).'&_aop_signature='.$sign;
            //通过curl get 方式发送至阿里
            $response=Helper_Curl::get1($url);
            QLog::log('trace_request'.json_encode($trace_request_data));
            QLog::log('trace_response'.$response);
            $response=json_decode($response,true);
            if(isset($response['success']) && $response['success']==true){
                $temp->send_flag='1';
                $temp->save();
                //如果轨迹是 F_DELIVERY_5048，将订单状改为已结束
                if($temp->tracking_code=='F_DELIVERY_5048'){
                	$order->order_status='13';
                	$order->save();
                }
            }else{
            	$temp->send_times=$temp->send_times+1;
            	$temp->save();
                $email_response=Helper_Mailer::send('986502672@qq.com', '发送轨迹失败', '阿里单号 '.$order->ali_order_no.',失败原因：'.json_encode($response));
                continue;
            }
            //自动确认签收事件
            if ($temp->tracking_code =='S_DELIVERY_SIGNED'){
	            $ev=Event::find('order_id =? and confirm_flag =0 and event_code="DELIVERY"',$temp->order_id)->getOne();
	            if (!$ev->isNewRecord()){
	            		$ev->confirm_flag=1;
	            		$ev->save();
	            }
            }
        }
        exit();
    }
   
    /**
     * 跟踪渠道末端轨迹
     */
    function actionRoute(){
    		$args=func_get_args();
    		$sleep=Q::cache('RouteSleep',array('life_time'=>3600));
    		if ($sleep && empty($args[3])){
    			self::log('sleep');
    			exit;
    		}
    		self::log('begin');
    		$select=Order::find('service_code in (?) and order_status in (?)',array('Express_Standard_Global','US-FY'), array(Order::STATUS_OUT,Order::STATUS_EXTRACTED,Order::STATUS_LOCK));
    		if (!empty($args[3]) && $args[3]!='force'){
    			$select->where('tracking_no =?',$args[3]);
    		}
    		$select= $select->order('update_time')
    			->setColumns('order_id,tracking_no,channel_id')
    			->all()
    			->getQueryHandle();
    		while ($row=$select->fetchRow()){
    			self::log($row['order_id']);
    			$order=Order::find('order_id =?',$row['order_id'])->getOne();
    			
    			if (!empty($row['tracking_no']) && !empty($row['channel_id'])){
    				self::log($row['tracking_no']);
    				$channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
    				$network_code=$channel->network_code;
    				$tnetwork_code=$channel->trace_network_code;
    				$trackings=Tracking::find('order_id =? and tracking_code<>"F_DELIVERY_5044" and yflag<>"1"',$row['order_id'])->getAll();
    				// 求最晚时间并转换为utc+8
    				if($network_code=='UPS'){
        				$evt=Event::find('order_id =? ',$row['order_id'])->order('event_time desc') ->getOne();
        				$lastTime=strtotime(date("Y-m-d 2:25:00",$evt->event_time))+86400*2;	//事件最后的时间+2天
    				}else {
    				    $lastTime=0;
    				}
    				if (count($trackings)) foreach ($trackings as $tr){
    					if ($tr->timezone==-19){
    						continue;
    					}
    					if($network_code=='UPS'){
        					if ($tr->trace_time + (8-$tr->timezone )*3600 > $lastTime ){
        						$lastTime =$tr->trace_time + (8-$tr->timezone )*3600;
        					}
    					}else {
    					    if ($tr->trace_time){
    					        $lastTime =$tr->trace_time + (8-$tr->timezone )*3600;
    					    }
    					}
    				}
    				
    				if ($network_code =='UPS' || $tnetwork_code=='UPS'){
    					$json=Helper_Curl::get('http://m.far800.com/?action=tracking&num='.$row['tracking_no'].'&lang=en');
						$routes=json_decode($json,TRUE);
    					if (!empty($routes['data']) && count($routes['data'])){
    						// 将轨迹按照时间升序排序
    						$routes['data']=array_reverse($routes['data']);
    						$prevLocation='';
    						foreach ($routes['data'] as $d){
    						    // 保存
    						    if(!isset($d['location']) || !isset($d['time']) || !isset($d['context']) || !$d['time'] || !$d['context']){
    						        continue;
    						    }
    						    if($d['context']<>'Order Processed: Ready for UPS' && $d['context']<>'Order Processed: In Transit to UPS'){
    						        if($order->order_status=='7'){
    						            $order->order_status='8';
    						            $order->save();
    						        }
    						    }
    							$r=Route::checkAndSave(array(
    								'network_code'=>'UPS',
    								'tracking_no'=>$row['tracking_no'],
    								'time'=>strtotime($d['time']),
    								'location'=>$d['location'],
    								'description'=>$d['context'],
    							    'code'=>$d['code']
    							));
    							if (!is_null($r)){
    								self::log('save');
    								//判断是否更改地址
    								if(!$order->address_change){
    									$tracking=Tracking::find('order_id=? and tracking_code="F_DELIVERY_5043"',$order->order_id)->getOne();
    									if (!$tracking->isNewRecord()){
    										$order->address_change='1';
    										$order->address_change_info='F_DELIVERY_5043:Delivery information needed,attempting to update it';
    										$order->save();
    									}else {
    										$change_array=array('corrected the street number','corrected the apartment number','corrected the postal code','delivery change','a request to modify the delivery address','delivery address has been updated','requested an alternate delivery address','updated the delivery information','request to modify the delivery address','updated the address','change of delivery');
    										foreach ($change_array as $value){
    											if(strpos(strtolower($d['context']), $value)!==false){
    												$order->address_change='1';
    												$order->address_change_info=$d['context'];
    												$order->save();
    												break;
    											}
    										}
    									}
    								}
    								if($r->description != 'Order Processed: Ready for UPS' && $r->description != 'Order Processed: In Transit to UPS'){
    								    $r->generateTrace($lastTime,$order,$prevLocation);
    								}
    							}
    							
    							if (strlen($d['location'])){
    								$prevLocation=$d['location'];
    							}
    						}
    						if(isset($routes['SDD']) && !empty($routes['SDD'])){
    						    $track=Tracking::find('order_id =? and tracking_code="F_DELIVERY_5044" and trace_desc_cn like ?',$row['order_id'],'%'.date('Y-m-d',$routes['SDD']).'%')->getOne();
    						    $track2=Tracking::find('order_id =? and tracking_code="F_DELIVERY_5044" and yflag="1"',$row['order_id'])->getOne();
    						    $track3=Tracking::find('order_id =? and tracking_code="S_DELIVERY_SIGNED"',$row['order_id'])->getOne();
    						    $tra=Tracking::find('order_id =? and tracking_code<>"F_DELIVERY_5044" and yflag<>"1" and confirm_flag<>"2"',$order->order_id)->order('tracking_id desc')->getOne();
    						    if($track->isNewRecord() && $track3->isNewRecord()){
    						        $order->present_time=$routes['SDD'];
    						        $order->save();
    						        if($tra->location){
        						        $track->changeProps(array(
        						            'order_id'=>$order->order_id,
        						            'far_no'=>$order->far_no,
        						            'tracking_code'=>'F_DELIVERY_5044',
        						            'timezone'=>'8',
        						            'confirm_flag'=>'1',
        						            'trace_time'=>time(),
        						            'location'=>$tra->location,
        						            'quantity'=>$tra->quantity,
        						            'trace_desc_cn'=>'预派时间:'.date('Y-m-d',$routes['SDD']),
        						            'trace_desc_en'=>'Scheduled for delivery as agreed',
        						            'yflag'=>'1'
        						        ));
        						        $track->save();
        						        if(!$track2->isNewRecord()){
        						            $track->trace_desc_cn='预派时间更新:'.date('Y-m-d',$routes['SDD']);
        						            $track->save();
        						        }
    						        }
    						    }
    						}
    					}
    				}
    			}
    		}
    		Q::writeCache('RouteSleep',true,array('life_time'=>3600));
    		exit;
    }
    
    /**
     * 跟踪EMS渠道末端轨迹
     */
    function actionEmsRoute(){
    	set_time_limit(0);
    	$select=Order::find("service_code='EMS-FY' and order_status in (?)",array(Order::STATUS_OUT,Order::STATUS_EXTRACTED));
    	$select= $select->setColumns('order_id,tracking_no,channel_id')->all()->getQueryHandle();
    	while ($row=$select->fetchRow()){
    		$order=Order::find('order_id =?',$row['order_id'])->getOne();
    		$quantity=Farpackage::find('order_id=?',$order->order_id)->sum('quantity','sum_quantity')->getAll();
    		if (!empty($row['tracking_no']) && !empty($row['channel_id'])){
    			$channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
    			$network_code=$channel->network_code;
    			if ($network_code =='EMS'){
    				$json=Helper_Curl::get1('http://211.156.193.140:8000/cotrackapi/api/track/mail/'.$row['tracking_no'],array(
    					'version:ems_track_cn_1.0','authenticate:jsmobile_c8c8jk890qws'
    				));
    				QLog::log($row['tracking_no'].'轨迹回执:'.$json);
    				$routes=json_decode($json,TRUE);
    				if (isset($routes['traces']) && count($routes['traces'])){
    					foreach ($routes['traces'] as $value){
    						//保存route
    						$route=Route::find("tracking_no=? and network_code='EMS' and description=?",$row['tracking_no'],$value['remark'])->getOne();
    						if($route->isNewRecord()){
    							$md5=md5($row['tracking_no'].$value['acceptTime'].$value['acceptAddress'].$value['remark']);
    							$route->changeProps(array(
    								'network_code'=>'EMS',
    								'md5'=>$md5,
    								'tracking_no'=>$row['tracking_no'],
    								'time'=>strtotime($value['acceptTime']),
    								'location'=>$value['acceptAddress'],
    								'description'=>$value['remark']
    							));
    							$route->save();
    							if($order->order_status=='7'){
    							    $order->order_status='8';
    							    $order->save();
    							}
    						}
    						if(strpos($value['remark'], '南京国际营销中心已收件')!==false){
    							//承运商取件事件
    							$carrier_pickup=Event::find("event_code='CARRIER_PICKUP' and order_id= ?",$row['order_id'])->getOne();
    							//转运轨迹：F_CARRIER_PICKUP_RT_5035
    							$pickup_track=Tracking::find("tracking_code='F_CARRIER_PICKUP_RT_5035' and trace_desc_cn like ? and order_id= ?",'%'.$row['tracking_no'].'%',$row['order_id'])->getOne();
    							//承运商取件事件
    							if ($carrier_pickup->isNewRecord()){
    								$event=new Event();
    								$event->changeProps(array(
    									'order_id'=>$order->order_id,
    									'event_code'=>'CARRIER_PICKUP',
    									'event_time'=>strtotime($value['acceptTime']),
    									'event_location'=>'南京',
    									'location'=>'南京',
    									'confirm_flag'=>'1',
    									'timezone'=>'8'
    								));
    								$event->save();
    								$order->carrier_pick_time=strtotime($value['acceptTime']);
    								$order->save();
    							}
    							//转运轨迹：F_CARRIER_PICKUP_RT_5035
    							if($pickup_track->isNewRecord()){
    								$trace=new Tracking();
    								$trace->changeProps(array(
    									'order_id'=>$order->order_id,
    									'far_no'=>$order->far_no,
    									'tracking_code'=>'F_CARRIER_PICKUP_RT_5035',
    									'location'=>'南京',
    									'trace_desc_cn'=>'包裹重新安排转运,转【'.$row['tracking_no'].'】',
            							'trace_desc_en'=>'Reschedule transshipment to EMS['.$row['tracking_no'].'].Track in:http://www.ems.com.cn/english.html or https://www.17track.net/en',
    									'timezone'=>'8',
    									'confirm_flag'=>'1',
    									'route_id'=>$route->id,
    									'quantity'=>$quantity['sum_quantity'],
    									'trace_time'=>strtotime($value['acceptTime'])+rand(0, 10)*60+rand(0, 10)
    								));
    								$trace->save();
    							}
    						}
	    					if(strpos($value['remark'], '妥投')!==false && strpos($value['remark'], '未妥投')===false && strpos($value['remark'], '退回 妥投')===false){
	    						//收件城市分区
	    						$time_zone=CityTimezone::find('code_word_two=? and city=?',$order->consignee_country_code,trim($order->consignee_city))->getOne();
	    						if($time_zone->isNewRecord()){
	    							$time_zone=CityTimezone::find('code_word_two=?',$order->consignee_country_code)->order('timezone desc')->getOne();
	    						}
	    						//签收事件
	    						$event_delivery=Event::find("event_code='DELIVERY' and order_id= ?",$order->order_id)->getOne();
	    						//签收轨迹
	    						$track_delivery=Tracking::find("tracking_code='S_DELIVERY_SIGNED' and order_id=?",$order->order_id)->getOne();
    							//签收轨迹
    							if($track_delivery->isNewRecord()){
    								$trace=new Tracking();
    								$trace->changeProps(array(
    									'order_id'=>$order->order_id,
    									'far_no'=>$order->far_no,
    									'tracking_code'=>'S_DELIVERY_SIGNED',
    									'location'=>$order->consignee_city,
    									'trace_desc_cn'=>'快件已签收',
    									'timezone'=>$time_zone->timezone,
    									'quantity'=>$quantity['sum_quantity'],
    									'confirm_flag'=>'1',
    									'route_id'=>$route->id,
    									'trace_time'=>strtotime($value['acceptTime'])
    								));
    								$trace->save();
    							}
    							//delivery事件
    							if ($event_delivery->isNewRecord()){
    								$event=new Event();
    								$event->changeProps(array(
    									'order_id'=>$order->order_id,
    									'event_code'=>'DELIVERY',
    									'event_time'=>strtotime($value['acceptTime']),
    									'event_location'=>$order->consignee_city,
    									'confirm_flag'=>'1',
    									'timezone'=>$time_zone->timezone
    								));
    								$event->save();
    								//$order->delivery_time=strtotime($value['acceptTime']);
    								//$order->order_status='9';
    								//$order->save();
    							}
    						}
    					}
    				}
    			}
    		}
    	}
    	exit;
    }
    
    /**
     * 跟踪FEDEX渠道末端轨迹
     * @param unknown $str
     */
    function actionFedexRoute(){
    	set_time_limit(0);
        $select=Order::find("service_code in (?) and order_status in (?)",array('WIG-FY','EUUS-FY'),array(Order::STATUS_OUT,Order::STATUS_EXTRACTED));
    	$select= $select->setColumns('order_id,tracking_no,channel_id')->all()->getQueryHandle();
    	//fedex测试账号信息
    	//$key='vOSDgWEXV7QnRbxP';
    	//$password='h2XRZgneNCQALyHjMP682U5re';
    	//$accountNumber='510087500';
    	//$meterNumber='100421805';
    	//fedex生产账号信息
    	$key='f5XzZpzEwekZ8TJv';
	    $password='ILI1RWIQVhrjIZFBY5CqNP41i';
	    $accountNumber='631526993';
	    $meterNumber='250139501';
    	while ($row=$select->fetchRow()){
    		$order=Order::find('order_id =?',$row['order_id'])->getOne();
    		if (!empty($row['tracking_no']) && !empty($row['channel_id'])){
    			$channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
    			$trackings=Tracking::find('order_id =?',$row['order_id'])->getAll();
    			$network_code=$channel->network_code;
    			$tnetwork_code=$channel->trace_network_code;
    			if ($network_code =='FEDEX' || $tnetwork_code == 'FEDEX'){
    				$province='';
    				if(in_array($order->consignee_country_code, array('US','CA'))){
    					$usca=Uscaprovince::find('province_name=?',strtolower(str_replace(' ','',$order->consignee_state_region_code)))->getOne();
    					if(!$usca->isNewRecord()){
    						$province=$usca->province_code_two;
    					}else{
    						$province=$order->consignee_city;
    					}
    				}
    				$res = array(
    					'soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v9="http://fedex.com/ws/track/v9"' => array(
    						'soapenv:Header' =>'',
    						'soapenv:Body' => array(
    							'v9:TrackRequest' => array(
    								'v9:WebAuthenticationDetail' => array(
    									'v9:UserCredential'=>array(
    										'v9:Key'=>$key,
    										'v9:Password'=>$password,
    									),
    								),
    								'v9:ClientDetail'=>array(
    									'v9:AccountNumber'=>$accountNumber,
    									'v9:MeterNumber'=>$meterNumber,
    									'v9:Localization'=>array(
    										'v9:LanguageCode'=>'EN',
    										'v9:LocaleCode'=>'US',
    									)
    								),
    								'v9:TransactionDetail'=>array(
    									'v9:CustomerTransactionId'=>'Track By Number_v9',
    									'v9:Localization'=>array(
    										'v9:LanguageCode'=>'EN',
    										'v9:LocaleCode'=>'US'
    									)
    								),
    								'v9:Version'=>array(
    									'v9:ServiceId'=>'trck',
    									'v9:Major'=>'9',
    									'v9:Intermediate'=>'1',
    									'v9:Minor'=>'0'
    								),
    								'v9:SelectionDetails'=>array(
    									'v9:CarrierCode'=>'FDXE',
    									'v9:PackageIdentifier'=>array(
    										'v9:Type'=>'TRACKING_NUMBER_OR_DOORTAG',
    										'v9:Value'=>$row['tracking_no']
    									),
    								),
    								'v9:ProcessingOptions'=>'INCLUDE_DETAILED_SCANS'
    							),
    						),
    					)
    				);
    				$res = Helper_xml::simpleArr2xml($res,null);
    				//fedex测试地址
    				//$url = "https://wsbeta.fedex.com:443/web-services";
    				//fedex正式地址
    				$url='https://ws.fedex.com:443/web-services';
    				$return = Helper_Curl::post($url, $res);
    				$return=self::xml_to_array($return);
    				if($return['TrackReply']['CompletedTrackDetails']['TrackDetails']){
    					$return=$return['TrackReply']['CompletedTrackDetails']['TrackDetails'];
    					if(isset($return['Notification']['Severity']) && $return['Notification']['Severity'] != 'ERROR'){
    						// 保存
    						if(count($return['Events'])>0){
    							foreach (array_reverse($return['Events']) as $d){
    								//过滤掉第一条轨迹
    								if (!isset($d['Address']['CountryCode'])){
    									continue;
    								}
    								$time_zone=substr($d['Timestamp'], 19,3);
    								if($time_zone<0){
    									$time_zone='-'.abs($time_zone);
    								}else {
    									$time_zone=abs($time_zone);
    								}
    								if($d['EventDescription']<>'Shipment information sent to FedEx'){
    								    if($order->order_status=='7'){
    								        $order->order_status='8';
    								        $order->save();
    								    }
    								}
    								$r=Route::checkAndSave(array(
    									'network_code'=>'FEDEX',
    									'tracking_no'=>$row['tracking_no'],
    									'time'=>strtotime(substr($d['Timestamp'], 0,19)),
    									'location'=>@$d['Address']['City'].','.@$d['Address']['StateOrProvinceCode'].','.@$d['Address']['CountryCode'],
    									'description'=>$d['EventDescription'].(isset($d['StatusExceptionDescription'])?' '.$d['StatusExceptionDescription']:''),
    									'time_zone'=>$time_zone,
    								    'code'=>$d['EventType']
    								));
    								if (!is_null($r)){
    								    if (strpos(strtoupper($r->description), 'PICKED UP')!==false){
    								        $r_event = Event::find('order_id = ? and event_code = "CARRIER_PICKUP"',$order->order_id)->getOne();
    								        if($r_event->isNewRecord()){
    								           $new_event = new Event();
    								           $new_event->changeProps(array(
                            					'order_id'=>$order->order_id,
                            					'event_code'=>'CARRIER_PICKUP',
                            					'event_time'=>$r->time,
//                             					'location'=>$d['Address']['City'],
                            					'event_location'=>$d['Address']['City'],
                            					'timezone'=>$time_zone,
                            					'confirm_flag'=>'1'
                            				   ));
                            				   $new_event->save();
    								        }
    								    }
    									$r->generateFedexTrace($order,$d['Address']['City'],$d['Address']['CountryCode']);
    								}
    							}
    							if(isset($return['EstimatedDeliveryTimestamp']) && !empty($return['EstimatedDeliveryTimestamp'])){
    							    $track=Tracking::find('order_id =? and tracking_code="F_DELIVERY_5044" and trace_desc_cn like ?',$row['order_id'],'%'.substr($return['EstimatedDeliveryTimestamp'], 0,10).'%')->getOne();
    							    $track2=Tracking::find('order_id =? and tracking_code="F_DELIVERY_5044" and yflag="1"',$row['order_id'])->getOne();
    							    $track3=Tracking::find('order_id =? and tracking_code="S_DELIVERY_SIGNED"',$row['order_id'])->getOne();
    							    $tr=Tracking::find('order_id =? and tracking_code<>"F_DELIVERY_5044" and yflag<>"1" and confirm_flag<>"2"',$order->order_id)->order('tracking_id desc')->getOne();
    							    if($track->isNewRecord() && $track3->isNewRecord()){
    							        $order->present_time=strtotime(substr($return['EstimatedDeliveryTimestamp'], 0,19));
    							        $order->save();
    							        if($tr->location){
        							        $track->changeProps(array(
        							            'order_id'=>$order->order_id,
        							            'far_no'=>$order->far_no,
        							            'tracking_code'=>'F_DELIVERY_5044',
        							            'timezone'=>'8',
        							            'confirm_flag'=>'1',
        							            'trace_time'=>time(),
        							            'location'=>$tr->location,
        							            'quantity'=>$tr->quantity,
        							            'trace_desc_cn'=>'预派时间:'.substr($return['EstimatedDeliveryTimestamp'], 0,10),
        							            'trace_desc_en'=>'Scheduled for delivery as agreed',
        							            'yflag'=>'1'
        							        ));
        							        $track->save();
        							        if(!$track2->isNewRecord()){
        							            $track->trace_desc_cn='预派时间更新:'.substr($return['EstimatedDeliveryTimestamp'], 0,10);
        							            $track->save();
        							        }
    							        }
    							    }
    							}
    						}
    					}
    				}
    			}
    		}
    	}
    	//sleep(900);
    	exit;
    }
    
    /**
     * 跟踪中美专线头程轨迹
     */
    function actionUsRoute(){
    	ini_set('max_execution_time', '0');
        set_time_limit(0);
        ini_set('default_socket_timeout', '20');
        $select=Order::find("service_code='US-FY' and order_status in (?)",array(Order::STATUS_OUT,Order::STATUS_EXTRACTED));
    	$select= $select->setColumns('order_id,tracking_no,channel_id,ems_order_id')->all()->getQueryHandle();
    	while ($row=$select->fetchRow()){
    		$order=Order::find('order_id =?',$row['order_id'])->getOne();
    		if (!empty($row['channel_id']) && !empty($row['tracking_no']) && !empty($row['ems_order_id'])){
    			$channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
    			$trackings=Tracking::find('order_id =?',$row['order_id'])->getAll();
                $rou=Route::find('tracking_no = ? and network_code = "UPS"',$row['tracking_no'])->order('id desc')->getOne();
                if(!$rou->isNewRecord()){
                    if($rou->description != 'Order Processed: Ready for UPS' && $rou->description != 'Order Processed: In Transit to UPS'){
                        continue;
                    }
                }
                $lastTime=0;
                if (count($trackings)) foreach ($trackings as $tr){
    				if ($tr->timezone==-19){
    					continue;
    				}
    				if ($tr->trace_time){
    					$lastTime =$tr->trace_time + (8-$tr->timezone )*3600;
    				}
    			}
    			$network_code=$channel->network_code;
    			if ($network_code =='US-FY'){
    				$params=array(
    					'token'=>'2rcBrK5k5QJFoejbaCs0',
    					'timestamp'=>time(),
    					'shippingNum'=>$row['ems_order_id'],
    				);
                    $url='http://b.fullspeedparcel.com/?c=shippingTrack&a=fullTrack';
                    Helper_Curl::$connecttimeout='120';
                    Helper_Curl::$timeout='120';
                    $r=Helper_Curl::post($url,self::getPostData('AJsFkok2ty31TaXPOXTD', $params));
                    QLog::log('UsRoute'.$row['tracking_no'].':'.$r);
    				$r=json_decode($r,true);
    				if($r['code']==0){
    				    $data=$r['data'];
                        krsort($data['list']);
                        foreach ($data['list'] as $list){
                            if($list['info']=='Data Received'){
    					        continue;
    					    }
    					    if($list['info']=='Arrived into the US' || $list['status']=='Arrived into the US'){
    					        $route=Route::checkAndSave(array(
    					            'network_code'=>$network_code,
    					            'tracking_no'=>$row['tracking_no'],
    					            'time'=>strtotime($list['time']),
    					            'location'=>$list['location'] ? $list['location'] :" ",
    					            'description'=>$list['status'],
    					        ));
    					        if (!is_null($route)){
        					        if(trim($list['location'])){
        					            $utc8=strtotime($list['time'])+13*3600;
        					            if($utc8 >= $lastTime){
        					                $qty=Orderpackage::find('order_id=?',$order->order_id)->getSum('quantity');
        					                $tring=new Tracking();
        					                $tring->changeProps(array(
        					                    'order_id'=>$order->order_id,
        					                    'far_no'=>$order->far_no,
        					                    'tracking_code'=>'S_TH_IN',
        					                    'timezone'=>'-5',
        					                    'confirm_flag'=>1,
        					                    'trace_time'=>strtotime($list['time']),
        					                    'location'=>$list['location'],
        					                    'quantity'=>$qty,
        					                    'trace_desc_cn'=>Tracking::$trace_code_cn['S_TH_IN'],
        					                    'trace_desc_en'=>'Arrived into the US',
        					                    'route_id'=>$route->id
        					                ));
        					                $tring->save();
        					            }
        					        }
    					        }
    					    }else {
    					        $info=$list['info'];
    					        if(!strpos($info, ']')){
    					            continue;
    					        }
    					        if(empty($list['location'])){
    					            continue;
    					        }
    					        if(strlen($list['status'])==2 || !$list['status']){
    					            continue;
    					        }
    					        if($order->order_status=='7'){
    					            $order->order_status='8';
    					            $order->save();
    					        }
    					        $info=str_replace("[", '', $info);
    					        $info=explode(']', $info);
    					        $info=explode(',', $info[0]);
    					        $route=Route::checkAndSave(array(
    					            'network_code'=>$network_code,
    					            'tracking_no'=>$row['tracking_no'],
    					            'time'=>strtotime($list['time']),
    					            'location'=>$list['location'].',,'.@$info[0],
    					            'description'=>$list['status'],
    					        ));
    					        if (!is_null($route)){
    					            $route->generateTrace($lastTime,$order);
    					        }
    					    }
                        }
    				}
    			}
    		}
    		sleep(3);
    	}
    	exit;
    }
    
    /*
     * 麦链头程轨迹
     */
    function actionMltRoute(){
        set_time_limit(0);
        $select=Order::find("service_code='EUUS-FY' and order_status in (?)",array(Order::STATUS_OUT,Order::STATUS_EXTRACTED));
        $select= $select->setColumns('order_id,tracking_no,channel_id')->all()->getQueryHandle();
        $gz=array('Shipment Picked up','In Transit','Export Customs Clearance Completed','Export Customs Clearance Exception: Inspection',
            'Export Customs Clearance Failure Will Return','In Transit to Airport','Scheduled to Take off','Departed Facility in','Flight Exception: Delaying',
            'Arrived at Sort Facility','Customs Status Updated','Transferred through');
        while ($row=$select->fetchRow()){
            $order=Order::find('order_id =?',$row['order_id'])->getOne();
            if (!empty($row['channel_id']) && !empty($row['tracking_no'])){
                $channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
                $trackings=Tracking::find('order_id =?',$row['order_id'])->getAll();
                $route=Route::find('tracking_no =? and network_code in (?)',$row['tracking_no'],array('DHL','DHLE','FEDEX'))->order('id desc')->getOne();;
                if(!$route->isNewRecord()){
                    if($route->description != 'Shipment information received'){
                        continue;
                    }
                }
                // 求最晚时间并转换为utc+8
                $lastTime=0;
                if (count($trackings)) foreach ($trackings as $tr){
                    if ($tr->timezone==-19){
                        continue;
                    }
                    if ($tr->trace_time){
                        $lastTime =$tr->trace_time + (8-$tr->timezone )*3600;
                    }
                }
                $network_code=$channel->network_code;
                $tnetwork_code=$channel->trace_network_code;
                if ($network_code =='YWML' || $tnetwork_code=="YWML"){
                    $url="http://47.107.46.136:8086/xms/services/order?wsdl";
                    $array=array(
                        'userToken'=>'a43fb2769566442291622d8c6e6d8b5c',
                        'trackingNo'=>$row['tracking_no'],
//                         'orderNo'=>$order->ali_order_no
                    );
                    $client=new SoapClient($url, array ('encoding' => 'UTF-8' ));
                    $str=$client->__soapCall('getTrack', $array);
                    $str=get_object_vars($str);
                    if($str['success']==1 || $str['success']){
                        $trace=get_object_vars($str['trace']);
                        if(count($trace['sPaths'])==1){
                            $i=0;
                            $spath=get_object_vars($trace['sPaths']);
                            $location=$spath['pathAddr'];
                            if(strpos($location, ',')){
                                $location=explode(',', $location);
                                if(strlen(@$location[1])==2){
                                    foreach ($gz as $g){
                                        if(strtoupper($spath['pathInfo'])==strtoupper($g)){
                                            $i++;
                                        }
                                    }
                                    if($i == 0){
                                        continue;
                                    }
                                    if($order->order_status=='7'){
                                        $order->order_status='8';
                                        $order->save();
                                    }
                                    $time_zone=substr($spath['pathTime'], 19,3);
                                    if($time_zone<0){
                                        $time_zone='-'.abs($time_zone);
                                    }else {
                                        $time_zone=abs($time_zone);
                                    }
                                    $r=Route::checkAndSave(array(
                                        'network_code'=>'YWML',
                                        'tracking_no'=>$row['tracking_no'],
                                        'time'=>strtotime(substr($spath['pathTime'], 0,19)),
                                        'location'=>@$location[0].',,'.@$location[1],
                                        'description'=>$spath['pathInfo'],
                                        'time_zone'=>$time_zone,
                                    ));
                                    if (!is_null($r)){
                                        $r->generateTrace($lastTime,$order);
                                    }
                                }else {
                                    continue;
                                }
                            }else {
                                continue;
                            }
                        }else {
                            foreach ($trace['sPaths'] as $spaths){
                                $i=0;
                                $spath=get_object_vars($spaths);
                                $location=$spath['pathAddr'];
                                if(strpos($location, ',')){
                                    $location=explode(',', $location);
                                    if(strlen(@$location[1])==2){
                                        foreach ($gz as $g){
                                            if(strtoupper($spath['pathInfo'])==strtoupper($g)){
                                                $i++;
                                            }
                                        }
                                        if($i == 0){
                                            continue;
                                        }
                                        if($order->order_status=='7'){
                                            $order->order_status='8';
                                            $order->save();
                                        }
                                        $time_zone=substr($spath['pathTime'], 19,3);
                                        if($time_zone<0){
                                            $time_zone='-'.abs($time_zone);
                                        }else {
                                            $time_zone=abs($time_zone);
                                        }
                                        $r=Route::checkAndSave(array(
                                            'network_code'=>'YWML',
                                            'tracking_no'=>$row['tracking_no'],
                                            'time'=>strtotime(substr($spath['pathTime'], 0,19)),
                                            'location'=>@$location[0].',,'.@$location[1],
                                            'description'=>$spath['pathInfo'],
                                            'time_zone'=>$time_zone,
                                        ));
                                        if (!is_null($r)){
                                            $r->generateTrace($lastTime,$order);
                                        }
                                    }else {
                                        continue;
                                    }
                                }else {
                                    continue;
                                }
                            }
                        }
                    }
                }
            }
        }
        exit;
    }
    
    /**
     * 跟踪麦链的5个DHL末端轨迹
     */
    function actionoldMlDhlRoute(){
    	set_time_limit(0);
    	$select=Order::find("service_code='EUUS-FY' and order_status in (?)",array(Order::STATUS_OUT,Order::STATUS_EXTRACTED));
    	$select= $select->setColumns('order_id,tracking_no,channel_id')->all()->getQueryHandle();
    	while ($row=$select->fetchRow()){
    		$order=Order::find('order_id =?',$row['order_id'])->getOne();
    		if (!empty($row['channel_id']) && !empty($row['tracking_no'])){
    			$channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
    			$trackings=Tracking::find('order_id =?',$row['order_id'])->getAll();
    
    			// 求最晚时间并转换为utc+8
//     			$evt=Event::find('order_id =? ',$row['order_id'])->order('event_time desc') ->getOne();
//     			$lastTime=strtotime(date("Y-m-d 2:25:00",$evt->event_time))+86400*2;	//事件最后的时间+2天
    			$lastTime=0;
    			if (count($trackings)) foreach ($trackings as $tr){
    				if ($tr->timezone==-19){
    					continue;
    				}
    				if ($tr->trace_time){
    					$lastTime =$tr->trace_time + (8-$tr->timezone )*3600;
    				}
    			}
    			$network_code=$channel->network_code;
    			$tnetwork_code=$channel->trace_network_code;
    			if ($network_code =='DHL' || $tnetwork_code == 'DHL'){
                   $arr=array(
    			        'req:KnownTrackingRequest schemaVersion="1.0" xsi:schemaLocation="http://www.dhl.com TrackingRequestKnown.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:req="http://www.dhl.com"' => array(
    			            'Request' => array(
    			                'ServiceHeader'=>array(
    			                    'MessageTime'=>date("Y-m-d").'T'.date("H:i:s").'+08:00',
    			                    'MessageReference'=>'TrackingRequest_Multiple_AWB',
    			                    'SiteID'=>'Dap0028test',
    			                    'Password'=>'faY8xUHe'
    			                )
    			            ),
    			            'LanguageCode'=>'en',
    			            'AWBNumber'=>$row['tracking_no'],
    			            'LevelOfDetails'=>'ALL_CHECK_POINTS',
    			            'PiecesEnabled'=>'B'
    			        )
    			    );
    			    $res = Helper_xml::simpleArr2xml($arr);
    			    $url = "https://xmlpitest-ea.dhl.com/XMLShippingServlet";
    			    $return = Helper_Curl::post($url, $res);
    			    QLog::log('MlDhlRoute'.$row['tracking_no'].':'.$return);
    			    $return = json_decode(json_encode(simplexml_load_string($return, 'SimpleXMLElement', LIBXML_NOCDATA)), true);
    			    if(isset($return['AWBInfo']['ShipmentInfo']['ShipmentEvent'])){
    			        if($order->order_status=='7'){
    			            $order->order_status='8';
    			            $order->save();
    			        }
    				    $ShipmentEvent=$return['AWBInfo']['ShipmentInfo']['ShipmentEvent'];
    				    if(isset($ShipmentEvent['Date'])){
    				        $event=$ShipmentEvent;
    				        $date=$event['Date'];
    				        $hour=$event['Time'];
    				        $ServiceEvent=@$event['ServiceEvent'];
    				        $location=@$event['ServiceArea']['Description'];
    				        $location=explode("-", $location);
    				        $loca=$location[0];
    				        $loca=explode(",", $loca);
    				        $r=Route::checkAndSave(array(
    				            'network_code'=>'DHL',
    				            'tracking_no'=>$row['tracking_no'],
    				            'time'=>strtotime($date.$hour),
    				            'location'=>@$loca[0].','.@$loca[1].','.(isset($location[2])?$location[2]:@$location[1]),
    				            'description'=>$ServiceEvent['Description'],
    				            'code'=>$ServiceEvent['EventCode']
    				        ));
    				        if (!is_null($r)){
    				            $r->generateTrace($lastTime,$order);
    				        }
    				    }else {
        				    foreach ($ShipmentEvent as $event){
        				        $date=$event['Date'];
    			                $hour=$event['Time'];
    			                $ServiceEvent=@$event['ServiceEvent'];
    			                $location=@$event['ServiceArea']['Description'];
    			                $location=explode("-", $location);
    			                $loca=$location[0];
    			                $loca=explode(",", $loca);
    			                $r=Route::checkAndSave(array(
    			                    'network_code'=>'DHL',
    			                    'tracking_no'=>$row['tracking_no'],
    			                    'time'=>strtotime($date.$hour),
    			                    'location'=>@$loca[0].','.@$loca[1].','.(isset($location[2])?$location[2]:@$location[1]),
    			                    'description'=>$ServiceEvent['Description'],
    							    'code'=>$ServiceEvent['EventCode']
    			                ));
    			                if (!is_null($r)){
    			                    $r->generateTrace($lastTime,$order);
    			                }
        				    }
    				    }
    				}elseif (isset($return['AWBInfo'][1]['ShipmentInfo']['ShipmentEvent'])){
    				    if($order->order_status=='7'){
    				        $order->order_status='8';
    				        $order->save();
    				    }
    				    $ShipmentEvent=$return['AWBInfo'][1]['ShipmentInfo']['ShipmentEvent'];
    				    if(isset($ShipmentEvent['Date'])){
    				        $event=$ShipmentEvent;
    				        $date=$event['Date'];
    				        $hour=$event['Time'];
    				        $ServiceEvent=@$event['ServiceEvent'];
    				        $location=@$event['ServiceArea']['Description'];
    				        $location=explode("-", $location);
    				        $loca=$location[0];
    				        $loca=explode(",", $loca);
    				        $r=Route::checkAndSave(array(
    				            'network_code'=>'DHL',
    				            'tracking_no'=>$row['tracking_no'],
    				            'time'=>strtotime($date.$hour),
    				            'location'=>@$loca[0].','.@$loca[1].','.(isset($location[2])?$location[2]:@$location[1]),
    				            'description'=>$ServiceEvent['Description'],
    				            'code'=>$ServiceEvent['EventCode']
    				        ));
    				        if (!is_null($r)){
    				            $r->generateTrace($lastTime,$order);
    				        }
    				    }else {
    				        foreach ($ShipmentEvent as $event){
    				            $date=$event['Date'];
    				            $hour=$event['Time'];
    				            $ServiceEvent=@$event['ServiceEvent'];
    				            $location=@$event['ServiceArea']['Description'];
    				            $location=explode("-", $location);
    				            $loca=$location[0];
    				            $loca=explode(",", $loca);
    				            $r=Route::checkAndSave(array(
    				                'network_code'=>'DHL',
    				                'tracking_no'=>$row['tracking_no'],
    				                'time'=>strtotime($date.$hour),
    				                'location'=>@$loca[0].','.@$loca[1].','.(isset($location[2])?$location[2]:@$location[1]),
    				                'description'=>$ServiceEvent['Description'],
    				                'code'=>$ServiceEvent['EventCode']
    				            ));
    				            if (!is_null($r)){
    				                $r->generateTrace($lastTime,$order);
    				            }
    				        }
    				    }
    				}elseif (isset($return['AWBInfo'][0]['ShipmentInfo']['ShipmentEvent'])){
    				    if($order->order_status=='7'){
    				        $order->order_status='8';
    				        $order->save();
    				    }
    				    $ShipmentEvent=$return['AWBInfo'][0]['ShipmentInfo']['ShipmentEvent'];
    				    if(isset($ShipmentEvent['Date'])){
    				        $event=$ShipmentEvent;
    				        $date=$event['Date'];
    				        $hour=$event['Time'];
    				        $ServiceEvent=@$event['ServiceEvent'];
    				        $location=@$event['ServiceArea']['Description'];
    				        $location=explode("-", $location);
    				        $loca=$location[0];
    				        $loca=explode(",", $loca);
    				        $r=Route::checkAndSave(array(
    				            'network_code'=>'DHL',
    				            'tracking_no'=>$row['tracking_no'],
    				            'time'=>strtotime($date.$hour),
    				            'location'=>@$loca[0].','.@$loca[1].','.(isset($location[2])?$location[2]:@$location[1]),
    				            'description'=>$ServiceEvent['Description'],
    				            'code'=>$ServiceEvent['EventCode']
    				        ));
    				        if (!is_null($r)){
    				            $r->generateTrace($lastTime,$order);
    				        }
    				    }else {
    				        foreach ($ShipmentEvent as $event){
    				            $date=$event['Date'];
    				            $hour=$event['Time'];
    				            $ServiceEvent=@$event['ServiceEvent'];
    				            $location=@$event['ServiceArea']['Description'];
    				            $location=explode("-", $location);
    				            $loca=$location[0];
    				            $loca=explode(",", $loca);
    				            $r=Route::checkAndSave(array(
    				                'network_code'=>'DHL',
    				                'tracking_no'=>$row['tracking_no'],
    				                'time'=>strtotime($date.$hour),
    				                'location'=>@$loca[0].','.@$loca[1].','.(isset($location[2])?$location[2]:@$location[1]),
    				                'description'=>$ServiceEvent['Description'],
    				                'code'=>$ServiceEvent['EventCode']
    				            ));
    				            if (!is_null($r)){
    				                $r->generateTrace($lastTime,$order);
    				            }
    				        }
    				    }
    				}
    			}
    		}
    	}
    	exit;
    }
    
    /**
     * 跟踪麦链的5个DHL末端轨迹
     */
    function actionMlDhlRoute(){
        set_time_limit(0);
        $select=Order::find("service_code='EUUS-FY' and order_status in (?)",array(Order::STATUS_OUT,Order::STATUS_EXTRACTED));
        
        $select= $select->setColumns('order_id,tracking_no,channel_id')->all()->getQueryHandle();
        while ($row=$select->fetchRow()){
            $order=Order::find('order_id =?',$row['order_id'])->getOne();
            if (!empty($row['channel_id']) && !empty($row['tracking_no'])){
                $channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
                $trackings=Tracking::find('order_id =? and tracking_code<>"F_DELIVERY_5044" and yflag<>"1"',$row['order_id'])->getAll();
                $lastTime=0;
                if (count($trackings)) foreach ($trackings as $tr){
                    if ($tr->timezone==-19){
                        continue;
                    }
                    if ($tr->trace_time){
                        $lastTime =$tr->trace_time + (8-$tr->timezone )*3600;
                    }
                }
                $network_code=$channel->network_code;
                $tnetwork_code=$channel->trace_network_code;
                if ($network_code =='DHL' || $tnetwork_code == 'DHL'){
                    $url = "https://www.dhl.com/shipmentTracking?AWB=".$row['tracking_no'];
                    $return = Helper_Curl::get($url);
                    QLog::log('MlDhlRoute'.$row['tracking_no'].':'.$return);
                    $return = json_decode($return, true);
                    if(isset($return['results'][0]['checkpoints'])){
                        $checkpoints=array_reverse($return['results'][0]['checkpoints']);
                        foreach ($checkpoints as $event){
                            if($order->order_status=='7' && $event['description']<>'Shipment information received'){
                                $order->order_status='8';
                                $order->save();
                            }
                            $date=$event['date'];
                            $hour=$event['time'];
                            $location=@$event['location'];
                            $location=explode("-", $location);
                            $country=@$location[1];
                            if(strpos($country, ',')){
                                $loca=$country;
                                $loca=explode(",", $loca);
                                $country=$loca[0];
                            }
                            if(strpos($event['description'], 'Delivered')!==false && empty($country)){
                                $country=$order->consignee_country_code;
                            }
                            $r=Route::checkAndSave(array(
                                'network_code'=>'DHL',
                                'tracking_no'=>$row['tracking_no'],
                                'time'=>strtotime($date.$hour),
                                'location'=>@$location[0].','.$country,
                                'description'=>$event['description'],
                            ));
                            if (!is_null($r) && $event['description']<>'Shipment information received'){
                                $r->generateTrace($lastTime,$order);
                            }
                        }
                        if(isset($return['results'][0]['edd']['date']) && !empty($return['results'][0]['edd']['date']) && isset($return['results'][0]['edd']['label']) && $return['results'][0]['edd']['label']=='Estimated Delivery'){
                            $time=strtotime($return['results'][0]['edd']['date']);
                            $track=Tracking::find('order_id =? and tracking_code="F_DELIVERY_5044" and trace_desc_cn like ?',$row['order_id'],'%'.date('Y-m-d',$time).'%')->getOne();
                            $track2=Tracking::find('order_id =? and tracking_code="F_DELIVERY_5044" and yflag="1"',$row['order_id'])->getOne();
                            $track3=Tracking::find('order_id =? and tracking_code="S_DELIVERY_SIGNED"',$row['order_id'])->getOne();
                            $tra=Tracking::find('order_id =? and tracking_code<>"F_DELIVERY_5044" and yflag<>"1" and confirm_flag<>"2"',$order->order_id)->order('tracking_id desc')->getOne();
                            if($track->isNewRecord() && $track3->isNewRecord()){
                                $order->present_time=$time;
                                $order->save();
                                if($tra->location){
                                    $track->changeProps(array(
                                        'order_id'=>$order->order_id,
                                        'far_no'=>$order->far_no,
                                        'tracking_code'=>'F_DELIVERY_5044',
                                        'timezone'=>'8',
                                        'confirm_flag'=>'1',
                                        'trace_time'=>time(),
                                        'location'=>$tra->location,
                                        'quantity'=>$tra->quantity,
                                        'trace_desc_cn'=>'预派时间:'.date('Y-m-d',$time),
                                        'trace_desc_en'=>'Scheduled for delivery as agreed',
                                        'yflag'=>'1'
                                    ));
                                    $track->save();
                                    if(!$track2->isNewRecord()){
                                        $track->trace_desc_cn='预派时间更新:'.date('Y-m-d',$time);
                                        $track->save();
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        exit;
    }
    
    /**
     * 跟踪麦链SH-DHL-MX末端轨迹
     */
    function actionmxroute(){
    	set_time_limit(0);
    	$select=Order::find("service_code='EUUS-FY' and order_status in (?)",array(Order::STATUS_OUT,Order::STATUS_EXTRACTED));
    	$select= $select->setColumns('order_id,tracking_no,channel_id')->all()->getQueryHandle();
    
    	while ($row=$select->fetchRow()){
    		$order=Order::find('order_id =?',$row['order_id'])->getOne();
    		if (!empty($row['tracking_no']) && !empty($row['channel_id'])){
    			$channel =Channel::find('channel_id =?',$row['channel_id'])->getOne();
    			$trackings=Tracking::find('order_id =?',$row['order_id'])->getAll();
    
    			// 求最晚时间并转换为utc+8
//     			$evt=Event::find('order_id =? ',$row['order_id'])->order('event_time desc') ->getOne();
//     			$lastTime=strtotime(date("Y-m-d 2:25:00",$evt->event_time))+86400*2;	//事件最后的时间+2天
    			$lastTime=0;
    			if (count($trackings)) foreach ($trackings as $tr){
    				if ($tr->timezone==-19){
    					continue;
    				}
    				if ($tr->trace_time){
    					$lastTime =$tr->trace_time + (8-$tr->timezone )*3600;
    				}
    			}
    			$network_code=$channel->network_code;
    			$tnetwork_code=$channel->trace_network_code;
    			if ($network_code =='DHLE' || $tnetwork_code == 'DHLE'){
    				$reslut=Helper_Curl::get("https://api.dhlecommerce.dhl.com/rest/v1/OAuth/AccessToken?clientId=LTIxNDEyOTEwNzM=&password=MjAzMDI5MTU");
    				$reslut=json_decode($reslut,true);
    				if(isset($reslut['accessTokenResponse']['token'])){
    					$arr=array(
    						'trackItemRequest'=>array(
    							'trackingReferenceNumber'=>array($row['tracking_no']),
    							'messageLanguage'=>'zh_EN',
    							'messageVersion'=>'1.1',
    							'token'=>$reslut['accessTokenResponse']['token']
    						),
    					);
    					$header=array(
    						'Content-Type:application/json'
    					);
    					$url='https://api.dhlecommerce.dhl.com/rest/v2/Tracking';
    					$return=Helper_Curl::post($url, json_encode($arr),$header);
    					QLog::log('mxroute'.$row['tracking_no'].':'.$return);
    					$return=json_decode($return,true);
    					if(isset($return['trackItemResponse']['items'])){
    						$items=$return['trackItemResponse']['items'];
    						foreach ($items as $item){
    							$events=$item['events'];
    							krsort($events);
    							foreach ($events as $e){
    							    if($e['description']<>'Shipment data received by 3rd party'){
    							        if($order->order_status=='7'){
    							            $order->order_status='8';
    							            $order->save();
    							        }
    							    }
    								$r=Route::checkAndSave(array(
    									'network_code'=>'DHLE',
    									'tracking_no'=>$row['tracking_no'],
    									'time'=>strtotime($e['timestamp']),
    									'location'=>@$e['address']['city'].','.@$e['address']['state'].','.@$e['address']['countryCode'],
    									'description'=>$e['description'],
    								    'code'=>$e['status']
    								));
    								if (!is_null($r)){
    									$r->generateTrace($lastTime,$order);
    								}
    							}
    						}
    					}
    				}
    			}
    		}
    	}
    	exit;
    }
    
    
    static function getPostData($key,$postData)
    {
    	ksort($postData); //除sign参数外， 数组按字母排序
    	$strPara = http_build_query($postData);
    	$sign = md5($strPara.$key);//签名
    	$postData['sign'] = $sign;
    	return http_build_query($postData);
    }
    
    
    
    /*
     * xml转array
     */
    static function xml_to_array( $xml ){
    	$reg = "/<(\\w+)[^>]*?>([\\x00-\\xFF]*?)<\\/\\1>/";
    	if(preg_match_all($reg, $xml, $matches)){
    		$count = count($matches[0]);
    		$arr = array();
    		for($i = 0; $i < $count; $i++){
	    		$key = $matches[1][$i];
	    		$val = self::xml_to_array( $matches[2][$i] );  // 递归
	    		if(array_key_exists($key, $arr)){
		    		if(is_array($arr[$key])){
		    			if(!array_key_exists(0,$arr[$key])){
			    			$arr[$key] = array($arr[$key]);
			    		}
		    		}else{
		    			$arr[$key] = array($arr[$key]);
		    		}
	    			$arr[$key][] = $val;
	    		}else{
	    			$arr[$key] = $val;
	    		}
    		}
    		return $arr;
    	}else{
    		return $xml;
    	}
    }
    
    static function log($str){
    		QLog::log($str);
    		echo date('Ymd H:i').']'.$str."\n";
    }
    
    /**
     * 推送数据到新的出库表格里
     */
    function actionsyncpackage(){
    	set_time_limit(0);
    	$farpackages=Farpackage::find()->getAll();
    	foreach ($farpackages as $f){
    		$order=Order::find('order_id=? and order_status=5',$f->order_id)->getOne();
    		if(!$order->isNewRecord()){
    			continue;
    		}
    		$faroutpackge=new Faroutpackage();
    		$faroutpackge->order_id=$f->order_id;
    		$faroutpackge->quantity_out=$f->quantity;
    		if($f->weight_out>0){
    			$faroutpackge->length_out=$f->length_out;
    			$faroutpackge->width_out=$f->width_out;
    			$faroutpackge->height_out=$f->height_out;
    			$faroutpackge->weight_out=$f->weight_out;
    		}else{
    			$faroutpackge->length_out=$f->length;
    			$faroutpackge->width_out=$f->width;
    			$faroutpackge->height_out=$f->height;
    			$faroutpackge->weight_out=$f->weight;
    		}
    		$faroutpackge->save();
    	}
    	exit;
    }
    
    /**
     * 测试拆分阿里推送过来的数据
     */
    function actiontestapi(){
    	$url='localhost/AliExpress/Code/api/orderbooking';
    	$requestBody='{"bookingOrderDTO":"{\"aliOrderNo\":\"ALS0020190824\",\"consignee\":{\"city\":\"North hudson\",\"countryCode\":\"US\",\"mobile\":\"7153772133\",\"name1\":\"Ceme-Tube LLC\",\"name2\":\"Ceme-Tube LLC\",\"postalCode\":\"54016\",\"stateRegionCode\":\"Wisconsin\",\"street1\":\"579 Schommer Dr\"},\"consignor\":{\"city\":\"苏州市\",\"countryCode\":\"CN\",\"email\":\"eric.hwang@wonsten.com\",\"mobile\":\"18112752189\",\"name1\":\"王欣跃\",\"postalCode\":\"215600\",\"stateRegionCode\":\"江苏省\",\"street1\":\"乐余镇兆丰开发区双丰路5号\"},\"customsDeclaration\":{\"currencyCode\":\"USD\",\"declarationType\":\"QT\",\"totalAmount\":1000},\"needInsurance\":false,\"needPickUp\":false,\"packages\":[{\"height\":40,\"length\":67,\"packageType\":\"BOX\",\"quantity\":1,\"unit\":\"CM\",\"weight\":40,\"weightUnit\":\"KG\",\"width\":40}],\"products\":[{\"declarationPrice\":1000,\"hasBattery\":false,\"hsCode\":\"9617001100\",\"productName\":\"撕碎机筛网\",\"productNameEn\":\"Screen for shredder \",\"productQuantity\":1,\"productUnit\":\"pcs\"}],\"referenceNo\":\"803678522198,803678522199\",\"serviceCode\":\"Express_Standard_Global\",\"warehouse\":{\"code\":\"ASP_FAR_SH_PD\",\"name\":\"泛远上海浦东仓\"}}","sign":"302c02147ab07e89a99b19c4fe7f79a1ec9d918a2989f3d4021439822da781fe778c67b5b07caffb00b15b8a7e73"}';
    	$r=Helper_Curl::post($url, $requestBody);
    	dump($r);
    	exit;
    }
    
    /**
     * 将阿里老订单里的运单号拆分到新表中
     */
    function actionsplitreference(){
    	set_time_limit(0);
    	$orders=Order::find('order_id <1452')->getAll();
    	foreach ($orders as $order){
    	  	if(strlen($order->reference_no)){
	        	$references=explode(",", $order->reference_no);
	        	foreach ($references as $r){
	        		$alireference=new Alireference();
	        		$alireference->order_id=$order->order_id;
	        		$alireference->reference_no=$r;
	        		$alireference->save();
	        	}
        	}
    	}
    	exit;
    }
    
    /**
     * 处理老数据的重量问题
     */
    function actioncalcweight(){
    	set_time_limit(0);
    	$orders=Order::find('ali_testing_order !="1" and order_status not in ("1","2","3","11") and order_id <1000')->getAll();
    	foreach ($orders as $order){
    		$far_in_packages=Farpackage::find('order_id=?',$order->order_id)->getAll();
    		//应收实重
    		if(!$order->weight_actual_in){
    			if(count($far_in_packages)){
    				$weight_actual_in=0;
    				foreach ($far_in_packages as $far_in_actual){
    					$weight_actual_in+=$far_in_actual->weight*$far_in_actual->quantity;
    				}
    				if($weight_actual_in>0){
    					$order->weight_actual_in=$weight_actual_in;
    					$order->save();
    				}
    			} 
    		}
    		//应收计费重
    		if(!$order->weight_income_in){
    			if(count($far_in_packages)){
    				 $weight_income_in=0;
    				 foreach ($far_in_packages as $far_in_income){
    				 	$volumn_weight=$far_in_income->length*$far_in_income->width*$far_in_income->height/5000;
    				 	$volumn=$volumn_weight>$far_in_income->weight;
    				 	if($volumn){
    				 		$weight_income_in+=$volumn_weight>20?ceil($volumn_weight)*$far_in_income->quantity:ceil($volumn_weight/0.5)*0.5*$far_in_income->quantity;
    				 	}else{
    				 		$weight_income_in+=$far_in_income->weight>20?ceil($far_in_income->weight)*$far_in_income->quantity:ceil($far_in_income->weight/0.5)*0.5*$far_in_income->quantity;
    				 	}
    				 	
    				 }
    				 if($weight_income_in>0){
    				 	$order->weight_income_in=$weight_income_in>20?ceil($weight_income_in):$weight_income_in;
    				 	$order->save();
    				 }
    			} 
    		}
    	}
    	exit;
    }
    
    /**
     * 自动计算老的应收费用
     */
    function actioncalcfee(){
    	set_time_limit(0);
    	$fees=Fee::find('fee_type="1" and amount is null and fee_item_name="基础运费"')->getAll();
    	foreach ($fees as $fee){
    		$order=Order::find("order_id=?",$fee->order_id)->getOne();
    		if($order->isNewRecord() || $order->order_status =='2' ||  $order->order_status =='3'){
    			continue;
    		}
    		//基础运费
    		$tracking_fee=0;
    		$partition_code='';
    		$partition_code2='';
    		$partition=Partition::find('partition_manage_id=1 and country_code_two=?',$order->consignee_country_code)->getAll();
    		foreach ($partition as $p){
    		    if(trim($p->postal_code) && (substr($p->postal_code, 0,strlen($order->consignee_postal_code))==$order->consignee_postal_code || substr($order->consignee_postal_code, 0,strlen($p->postal_code))==$p->postal_code)){
    		        $partition_code=$p->partition_code;
    		    }
    		    if(!$p->postal_code){
    		        $partition_code2=$p->partition_code;
    		    }
    		}
    		if(!$partition_code){
    		    $partition_code=$partition_code2;
    		}
    		//获取价格
    		$price=Price::find('price_manage_id=3 and partition_code=? and boxing_type=? and start_weight<? and end_weight>=?',$partition_code,"BOX",$order->weight_income_in,$order->weight_income_in)->getOne();
    		if($price->isNewRecord()){
    			continue;
    		}
    		if($price->additional_weight>0){
    			if(($order->weight_income_in-$price->first_weight)>0){
    				$tracking_fee=(ceil(($order->weight_income_in-$price->first_weight)/$price->additional_weight)*$price->additional_fee)+$price->first_fee;
    			}else{
    				$tracking_fee=$price->first_fee;
    			}
    		}else{
    			if(($order->weight_income_in-$price->first_weight)>0){
    				$tracking_fee=(($order->weight_income_in-$price->first_weight)*$price->additional_fee)+$price->first_fee;
    			}else{
    				$tracking_fee=$price->first_fee;
    			}
    		}
    		if($tracking_fee<=0){
    			continue;
    		}
    		$fee->amount=$tracking_fee;
    		$fee->save();
    		
    		//燃油附加费
    		$fuel_amount=0;
    		$fuel_fee=Fee::find('fee_type="1" and amount is null and fee_item_name="燃油附加费" and order_id=?',$order->order_id)->getOne();
    		if($fuel_fee->isNewRecord()){
    			continue;
    		}
    		$fuel_amount=Fee::find('fee_type="1" and fee_item_name in ("基础运费","超尺寸/超重附加费","偏远地区附加费") and order_id=?',$order->order_id)->getSum("amount");
    		if($fuel_amount<=0){
    			continue;
    		}
    		$fuel_fee->amount=sprintf("%.2f",$fuel_amount*0.15);
    		$fuel_fee->save();
    	}
    	exit;
    }
    
    /**
     * 处理老数据的毛利
     */
    function actioncalcprofit(){
    	set_time_limit(0);
    	$orders=Order::find('order_id <5119 and ifnull(profit,"")="" ')->getAll();
    	foreach ($orders as $order){
    		$shou=Fee::find("order_id=? and fee_type='1'",$order->order_id)->getSum(amount);
    		$fu=Fee::find("order_id=? and fee_type='2'",$order->order_id)->getSum(amount);
    		$amout=$shou-$fu;
    		if($amout){
    			$order->profit=$amout;
    			$order->save();
    		}
    	}
    	exit;
    }
    
    /**
     * 检索老数据中更改地址的订单
     */
    function actionchangeaddress(){
    	set_time_limit(0);
    	$orders=Order::find()->getAll();
    	foreach ($orders as $order){
    		$tracking=Tracking::find('order_id=? and tracking_code="F_DELIVERY_5043"',$order->order_id)->getOne();
    		if (!$tracking->isNewRecord()){
    			$order->address_change='1';
    			$order->address_change_info='F_DELIVERY_5043:Delivery information needed,attempting to update it';
    			$order->save();
    		}else {
    			$change_array=array('corrected the street number','corrected the apartment number','corrected the postal code','delivery change','a request to modify the delivery address','delivery address has been updated','requested an alternate delivery address','updated the delivery information','request to modify the delivery address','updated the address','change of delivery');
    			$routes=Route::find('tracking_no=?',$order->tracking_no)->getAll();
    			foreach ($routes as $route){
    				foreach ($change_array as $value){
    					if(strpos(strtolower($route->description), $value)!==false){
    						$order->address_change='1';
    						$order->address_change_info=$route->description;
    						$order->save();
    						//跳出两层循环
    						 break 2;
    					}
    				}
    			}
    		}
    	}
    	exit;
    }
    
    /**
     * 发送面单给阿里（已打印之后才发送）
     */
    function actionuploadRecordForm(){
        set_time_limit(0);
        $url_sign='https://gw.open.1688.com/openapi/param2/1/ali.intl.onetouch/logistics.order.uploadRecordForm/563333';
        $select = Order::find("order_status = '6' and send_ali_form !='1' and ali_testing_order !='1' and send_times< 2 ")->setColumns('order_id')->all()->getQueryHandle();
        while (($row = $select->fetchRow()) != false) {
            $order = Order::find('order_id=?', $row['order_id'])->getOne();
            if($order->isNewRecord()){
            	continue;
            }
            if(strtoupper(substr($order->ali_order_no, 0,3))!='ALS'){
                continue;
            }
            $i=1;
            $total_value='';
            foreach ($order->product as $v){
            	if($i>=4){
            		break;
            	}
            	$invoice['items'][]=array(
            		'prdoduct_name_hs'=>$v->product_name_far.' '.$v->product_name_en_far.' '.$v->hs_code_far,
            		'quantity'=>$v->product_quantity,
            		'price'=>$v->declaration_price,
            		'itotal'=>round($v->product_quantity*$v->declaration_price,2),
            	);
            	$total_value += round($v->product_quantity*$v->declaration_price,2);
            	$i++;
            }
            $toal_package=Farpackage::find('order_id=?',$order->order_id)->getSum('quantity');
            $total_weight=sprintf("%.2f",$order->weight_income_in);
            
            //仓库名称
            $consignor='From Consignor : ';
            //发件人相关信息：
            $shipper="Shipper: ";
            if($order->department_id==6){
            	$consignor.="Far's warehouse in Hangzhou";
            	$shipper.='1st Floor, No.43 Ganchang Road, Xiacheng District, Hangzhou, Zhejiang, China  310022 ';
            	$shipper.='Miss.Zhang ';
            	$shipper.='0571-87834076';
            	//上海仓
            }elseif ($order->department_id==7){
            	$consignor.="Far's warehouse in Shanghai";
            	$shipper.='No. 12, Jinshun Road, Zhuqiao Town, Pudong New Area, Shanghai,China 201323 ';
            	$shipper.='Mr.Gu ';
            	$shipper.='021-58590952';
            	//义乌仓
            }elseif ($order->department_id==8){
            	$consignor.="Far's warehouse in Yiwu";
            	$shipper.='No.675-2 Airport Road, Yiwu City, Zhejiang Province,China 322000 ';
            	$shipper.='Mr.Yang ';
            	$shipper.='0579-85119351';
            	//广州仓
            }elseif ($order->department_id==22){
            	$consignor.="Far's warehouse in Guangzhou";
            	$shipper.='No.7-10, Heming Business Building, Baiyun Third Line, Helong Street, Baiyun District, Guangzhou City, Guangdong Province,China 510080 ';
            	$shipper.='Miss.Li ';
            	$shipper.='020-36301839';
            	//青岛仓
            }elseif ($order->department_id==23){
            	$consignor.="Far's warehouse in Qingdao";
            	$shipper.='No.4 Reservoir Area, Shanhang Logistics Park, No.31 Liangjiang Road, Chengyang District, Qingdao City, Shandong Province,China 266108 ';
            	$shipper.='Mr Wang ';
            	$shipper.='18661786160';
            	//深圳仓
            }elseif ($order->department_id==24){
            	$consignor.="FAR's warehouse in Shenzhen Longhua";
            	$shipper.='Unit 5,No.8 Non-bonded Warehouse, South China International Logistics Center,No.1 Mingkang Road,Minzhi Street,Longhua New District,Shenzhen City,China 518000 ';
            	$shipper.='Mr Wang ';
            	$shipper.='4000857988';
            }
            
            $dir=Q::ini('upload_tmp_dir');
            @Helper_Filesys::mkdirs($dir);
            $barcode=$dir.DS.$order->order_id.'.barcode.png';
            $logo=$dir.DS.'logo.png';
            $source=trim(file_get_contents('http://kuaijian.far800.com/public/barcode/html/image.php?filetype=PNG&dpi=90&scale=20&rotation=0&font_family=0&font_size=0&thickness=70&start=C&code=BCGcode128&text='.$order->far_no));
            file_put_contents($barcode, $source);
            $pdf=new PDF_Chinese('L','mm','far');
            $pdf->AddGBFont('simhei', '黑体');
            $pdf->AddPage();
            $pdf->SetFont('Arial','B',12);
            //阿里单号
            $pdf->Cell(84,6,'Order No. :'.$order->ali_order_no,'1');
            $pdf->Cell(66,6,'','TR');
            $pdf->Ln();
            $pdf->Cell(84,20,'','1','','C');
            //泛远单号条形码
            $pdf->Image($barcode,'12','19','80','14');
            //泛远logo
            $pdf->Image($logo,'95','15','63','20');
            $pdf->Cell(66,20,'','R');
            $pdf->Ln();
            //泛远单号
            $pdf->Cell(84,6,$order->far_no,'1','','C');
            $pdf->SetFont('Arial','B',10);
            //产品
            $pdf->Cell(66,6,$order->service_code,'RB','','C');
            $pdf->Ln();
            $pdf->SetFont('Arial','B',12);
            //仓库名称
            $pdf->Cell(150,8,$consignor,'1');
            $pdf->Ln();
            //发件人相关信息
            $pdf->MultiCell(150,8,$shipper,'1');
            //收件人姓名
            $pdf->MultiCell(150,6,'To Consignee: '.$order->consignee_name1.' '.$order->consignee_name2,'1');
            $pdf->SetFont('Arial','B',12);
            //收件人地址1
            $pdf->MultiCell(150,8,'Street Address1: '.$order->consignee_street1,'1');
            //收件人地址2
            $pdf->MultiCell(150,8,'Street Address2: '.$order->consignee_street2,'1');
            //收件人城市和邮编
            $pdf->Cell(99,8,'City&PostCode: '.$order->consignee_city.' '.$order->consignee_postal_code,'1');
            $pdf->SetFont('Arial','B',10);
            //收件人行政区/州
            $pdf->Cell(51,8,'State: '.$order->consignee_state_region_code,'1');
            $pdf->Ln();
            $pdf->SetFont('Arial','B',11);
            //收件人电话
            $pdf->Cell(99,8,'Contact Phone: '.$order->consignee_mobile,'1');
            //收件人国家
            $pdf->Cell(51,8,'Country: '.$order->consignee_country_code,'1');
            $pdf->Ln();
            $pdf->SetFont('Arial','B',12);
            $pdf->Cell(150,8,'SHIPMENT INFORMATION:','1','','C');
            $pdf->Ln();
            $pdf->Cell(99,7,'Main Products List','1','','C');
            $pdf->SetFont('Arial','B',10);
            $pdf->Cell(14,7,'Amount','1','','C');
            $pdf->Cell(20,7,'Price/Unit','1','','C');
            $pdf->Cell(17,7,'Subtotal','1','','C');
            foreach ($invoice['items'] as $in){
            	$pdf->Ln();
            	$pdf->SetFont('simhei','',9);
            	//FAR中文品名FAR英文品名FARHS编码
            	$pdf->Cell(99,6,iconv("utf-8","gbk",$in['prdoduct_name_hs']),'1','','L');
            	$pdf->SetFont('Arial','B',11);
            	//产品数量
            	$pdf->Cell(14,6,$in['quantity'],'1','','C');
            	//单价
            	$pdf->Cell(20,6,$in['price'],'1','','C');
            	//总价
            	$pdf->Cell(17,6,$in['itotal'],'1','','C');
            }
            $pdf->Ln();
            $pdf->SetFont('Arial','B',11);
            $pdf->Cell(99,6,'','1');
            $pdf->Cell(34,6,'Total Value(USD):','1','','C');
            //产品总价
            $pdf->Cell(17,6,$total_value,'1','','C');
            $pdf->Ln();
            $pdf->SetFont('Arial','B',14);
            $pdf->Cell(99,8,'Total packages','1','','C');
            $pdf->Cell(51,8,'Total Weight(KG):','1','','C');
            $pdf->Ln();
            //包裹件数
            $pdf->Cell(99,8,$toal_package,'1','','C');
            //包裹重
            $pdf->Cell(51,8,$total_weight,'1','','C');
            $pdf->Ln();
            $pdf->Cell(150,8,'Shipping Charges Payment Term: Prepaid&DDU','1');
            $pdf->Ln();
            $pdf->MultiCell(150,7,'Declaration Statement:I hereby certify that the information of this invoice is truce and correct and the contents and value of this shipment is as stated above.','1','L');
            $alilabel=$dir.DS.$order->order_id.'.pdf';
            $pdf->Output($alilabel,'F');
            $pdf->Close();
            exec("/usr/bin/convert -density 300 -depth 8 -quality 85 {$alilabel} -append {$alilabel}.jpg");
            $recordformdata=file_get_contents($alilabel.'.jpg');
            //uploadRecordFormDTO数据
            $recordform_request_data=array(
            	'aliOrderNo'=>$order->ali_order_no,
            	'recordFormType'=>'farLabel',
            	'recordFormData'=>base64_encode($recordformdata)
            );
            //QLog::log(json_encode($recordform_request_data));
            $ali=new Helper_ALI();
            $sign=$ali->sign($url_sign, json_encode($recordform_request_data),'uploadRecordForm');
            $post_data='uploadRecordFormDTO='.urlencode(json_encode($recordform_request_data)).'&_aop_signature='.$sign;
            QLog::log($post_data);
            //通过curl post 方式发送至阿里x-www-form-urlencoded 方式发送
            $response=Helper_Curl::post($url_sign, $post_data,array(
            	'Content-Type:application/x-www-form-urlencoded'
            ));
            QLog::log('ali_form_response:'.$response);
            $response=json_decode($response,true);
            if(isset($response['success']) && $response['success']==true){
            	$order->send_ali_form='1';
            	$order->save();
            }else{
            	$order->send_ali_form_error=$response['message'];
            	$order->send_times+=1;
            	$order->save();
            	$email_response=Helper_Mailer::send('986502672@qq.com', '发送面单失败', '阿里单号 '.$order->ali_order_no);
            }
        }
        exit();
    }
    
    /**
     * 测试发送中性面单给阿里
     */
    function actionTestUploadone(){
    	ini_set('max_execution_time', '0');
    	set_time_limit(0);
    	//ALS00200398537
    	$order = Order::find("ali_order_no='ALS00000580001'")->getOne();
    	if (!$order->isNewRecord()) {
    		$i=1;
    		$total_value='';
    		foreach ($order->product as $v){
    			if($i>=4){
    				break;
    			}
    			$invoice['items'][]=array(
    				'prdoduct_name_hs'=>$v->product_name_far.' '.$v->product_name_en_far.' '.$v->hs_code_far,
    				'quantity'=>$v->product_quantity,
    				'price'=>$v->declaration_price,
    				'itotal'=>round($v->product_quantity*$v->declaration_price,2),
    			);
    			$total_value += round($v->product_quantity*$v->declaration_price,2);
    			$i++;
    		}
    		$toal_package=Farpackage::find('order_id=?',$order->order_id)->getCount();
    		$total_weight=$order->weight_income_in;
    
    		//仓库名称
    		$consignor='From Consignor : ';
    		//发件人相关信息：
    		$shipper="Shipper: ";
    		if($order->department_id==6){
    			$consignor.="Far's warehouse in Hangzhou";
    			$shipper.='1st Floor, No.43 Ganchang Road, Xiacheng District, Hangzhou, Zhejiang, China  310022 ';
    			$shipper.='Miss.Zhang ';
    			$shipper.='0571-87834076';
    			//上海仓
    		}elseif ($order->department_id==7){
    			$consignor.="Far's warehouse in Shanghai";
    			$shipper.='No. 12, Jinshun Road, Zhuqiao Town, Pudong New Area, Shanghai,China 201323 ';
    			$shipper.='Mr.Gu ';
    			$shipper.='021-58590952';
    			//义乌仓
    		}elseif ($order->department_id==8){
    			$consignor.="Far's warehouse in Yiwu";
    			$shipper.='No.675-2 Airport Road, Yiwu City, Zhejiang Province,China 322000 ';
    			$shipper.='Mr.Yang ';
    			$shipper.='0579-85119351';
    			//广州仓
    		}elseif ($order->department_id==22){
            	$consignor.="Far's warehouse in Guangzhou";
            	$shipper.='No.7-10, Heming Business Building, Baiyun Third Line, Helong Street, Baiyun District, Guangzhou City, Guangdong Province,China 510080 ';
            	$shipper.='Miss.Li ';
            	$shipper.='020-36301839';
            	//青岛仓
            }elseif ($order->department_id==23){
            	$consignor.="Far's warehouse in Qingdao";
            	$shipper.='No.4 Reservoir Area, Shanhang Logistics Park, No.31 Liangjiang Road, Chengyang District, Qingdao City, Shandong Province,China 266108 ';
            	$shipper.='Mr Wang ';
            	$shipper.='18661786160';
            	//深圳仓
            }elseif ($order->department_id==24){
            	$consignor.="FAR's warehouse in Shenzhen Longhua";
            	$shipper.='Unit 5,No.8 Non-bonded Warehouse, South China International Logistics Center,No.1 Mingkang Road,Minzhi Street,Longhua New District,Shenzhen City,China 518000 ';
            	$shipper.='Mr Wang ';
            	$shipper.='4000857988';
            }
    
    		$dir=Q::ini('upload_tmp_dir');
    		@Helper_Filesys::mkdirs($dir);
    		$barcode=$dir.DS.$order->order_id.'.barcode.png';
    		$logo=$dir.DS.'logo.png';
    		$source=trim(file_get_contents('http://kuaijian.far800.com/public/barcode/html/image.php?filetype=PNG&dpi=90&scale=20&rotation=0&font_family=0&font_size=0&thickness=70&start=C&code=BCGcode128&text='.$order->far_no));
    		file_put_contents($barcode, $source);
    		$pdf=new PDF_Chinese('L','mm','far');
    		$pdf->AddGBFont('simhei', '黑体');
    		$pdf->AddPage();
    		$pdf->SetFont('Arial','B',12);
    		//阿里单号
    		$pdf->Cell(84,6,'Order No. :'.$order->ali_order_no,'1');
    		$pdf->Cell(66,6,'','TR');
    		$pdf->Ln();
    		$pdf->Cell(84,20,'','1','','C');
    		//泛远单号条形码
    		$pdf->Image($barcode,'12','19','80','14');
    		//泛远logo
    		$pdf->Image($logo,'95','15','63','20');
    		$pdf->Cell(66,20,'','R');
    		$pdf->Ln();
    		//泛远单号
    		$pdf->Cell(84,6,$order->far_no,'1','','C');
    		$pdf->SetFont('Arial','B',10);
    		//产品
    		$pdf->Cell(66,6,$order->service_code,'RB','','C');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',12);
    		//仓库名称
    		$pdf->Cell(150,8,$consignor,'1');
    		$pdf->Ln();
    		//发件人相关信息
    		$pdf->MultiCell(150,8,$shipper,'1');
    		//收件人姓名
    		$pdf->MultiCell(150,6,'To Consignee: '.$order->consignee_name1.' '.$order->consignee_name2,'1');
    		$pdf->SetFont('Arial','B',12);
    		//收件人地址1
    		$pdf->MultiCell(150,8,'Street Address1: '.$order->consignee_street1,'1');
    		//收件人地址2
    		$pdf->MultiCell(150,8,'Street Address2: '.$order->consignee_street2,'1');
    		//收件人城市和邮编
    		$pdf->Cell(99,8,'City&PostCode: '.$order->consignee_city.' '.$order->consignee_postal_code,'1');
    		$pdf->SetFont('Arial','B',10);
    		//收件人行政区/州
    		$pdf->Cell(51,8,'State: '.$order->consignee_state_region_code,'1');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',11);
    		//收件人电话
    		$pdf->Cell(99,8,'Contact Phone: '.$order->consignee_mobile,'1');
    		//收件人国家
    		$pdf->Cell(51,8,'Country: '.$order->consignee_country_code,'1');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',12);
    		$pdf->Cell(150,8,'SHIPMENT INFORMATION:','1','','C');
    		$pdf->Ln();
    		$pdf->Cell(99,7,'Main Products List','1','','C');
    		$pdf->SetFont('Arial','B',10);
    		$pdf->Cell(14,7,'Amount','1','','C');
    		$pdf->Cell(20,7,'Price/Unit','1','','C');
    		$pdf->Cell(17,7,'Subtotal','1','','C');
    		foreach ($invoice['items'] as $in){
    			$pdf->Ln();
    			$pdf->SetFont('simhei','',9);
    			//FAR中文品名FAR英文品名FAR HS编码
    			$pdf->Cell(99,6,iconv("utf-8","gbk",$in['prdoduct_name_hs']),'1','','L');
    			$pdf->SetFont('Arial','B',11);
    			//产品数量
    			$pdf->Cell(14,6,$in['quantity'],'1','','C');
    			//单价
    			$pdf->Cell(20,6,$in['price'],'1','','C');
    			//总价
    			$pdf->Cell(17,6,$in['itotal'],'1','','C');
    		}
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',11);
    		$pdf->Cell(99,6,'','1');
    		$pdf->Cell(34,6,'Total Value(USD):','1','','C');
    		//产品总价
    		$pdf->Cell(17,6,$total_value,'1','','C');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',14);
    		$pdf->Cell(99,8,'Total packages','1','','C');
    		$pdf->Cell(51,8,'Total Weight(KG):','1','','C');
    		$pdf->Ln();
    		//包裹件数
    		$pdf->Cell(99,8,$toal_package,'1','','C');
    		//包裹重
    		$pdf->Cell(51,8,$total_weight,'1','','C');
    		$pdf->Ln();
    		$pdf->Cell(150,8,'Shipping Charges Payment Term: Prepaid&DDU','1');
    		$pdf->Ln();
    		$pdf->MultiCell(150,7,'Declaration Statement:I hereby certify that the information of this invoice is truce and correct and the contents and value of this shipment is as stated above.','1','L');
    		$alilabel=$dir.DS.$order->order_id.'.pdf';
    		$pdf->Output($alilabel,'F');
    		$pdf->Close();
    		exec("/usr/bin/convert -density 300 -depth 8 -quality 85 {$alilabel} -append {$alilabel}.jpg");
    		$recordformdata=file_get_contents($alilabel.'.jpg');
    		//uploadRecordFormDTO数据
    		$array=array(
    			'aliOrderNo'=>$order->ali_order_no,
    			'recordFormType'=>'farLabel',
    			'recordFormData'=>base64_encode($recordformdata)
    		);
    		$url_sign='http://112.124.134.6:80/openapi/param2/1/ali.intl.onetouch/logistics.order.uploadRecordForm/831170';
    		$ali=new Helper_ALI();
    		$secretKey='fq6nVNy02u';
    		$urlpath=strstr($url_sign, 'param2/');
    		$s=$urlpath.'uploadRecordForm'.'DTO'.json_encode($array);
    		$sign=strtoupper(bin2hex(hash_hmac('sha1',$s,$secretKey,true)));
    		$post_data='uploadRecordFormDTO='.urlencode(json_encode($array)).'&_aop_signature='.$sign;
    		QLog::log($post_data);
    		//通过curl post 方式发送至阿里x-www-form-urlencoded 方式发送
    		$response=Helper_Curl::post($url_sign, $post_data,array(
	        	'Content-Type:application/x-www-form-urlencoded'
	   		 ));
    		QLog::log('ali_form_response:'.$response);
    		$response=json_decode($response,true);
    		if(isset($response['success']) && $response['success']==true){
    			$order->send_ali_form='1';
    			$order->save();
    		}else{
    			$order->send_ali_form_error=$response['message'];
    			$order->save();
    		}
    	}
    	exit();
    }
    
    /**
     * 测试接收阿里的单证错误信息
     */
    function actionTestaliformexception(){
    	$url='http://1688.far800.com/api/notifyformexception';
    	$exceptionDTO=array('aliOrderNo'=>'ALS00000576004','recordFormType'=>'farLabel','exceptionMessage'=>'商品申报数量不一致');
    	$exception=array('sign'=>'ABCD134567890','notifyFormExceptionDTO'=>json_encode($exceptionDTO));
    	QLog::log(json_encode($exception));
    	$response=Helper_Curl::post($url, json_encode($exception));
    }
    
    /**
     * 测试发送面单给阿里（出库之后才发送）
     */
    function actiontestuploadRecordForm(){
    	set_time_limit(0);
    	$select = Order::find("send_ali_form='1' and order_id >7933")->setColumns('order_id')->all()->getQueryHandle();
    	while (($row = $select->fetchRow()) != false) {
    		$order = Order::find('order_id=?', $row['order_id'])->getOne();
    		if($order->isNewRecord()){
    			continue;
    		}
    		$i=1;
    		$total_value='';
    		foreach ($order->product as $v){
    			if($i>=4){
    				break;
    			}
    			$invoice['items'][]=array(
    				'prdoduct_name_hs'=>$v->product_name_far.' '.$v->product_name_en_far.' '.$v->hs_code_far,
    				'quantity'=>$v->product_quantity,
    				'price'=>$v->declaration_price,
    				'itotal'=>round($v->product_quantity*$v->declaration_price,2),
    			);
    			$total_value += round($v->product_quantity*$v->declaration_price,2);
    			$i++;
    		}
    		$toal_package=Farpackage::find('order_id=?',$order->order_id)->getCount();
    		$total_weight=$order->weight_income_in;
    
    		//仓库名称
    		$consignor='From Consignor : ';
    		//发件人相关信息：
    		$shipper="Shipper: ";
    		if($order->department_id==6){
    			$consignor.="Far's warehouse in Hangzhou";
    			$shipper.='1st Floor, No.43 Ganchang Road, Xiacheng District, Hangzhou, Zhejiang, China  310022 ';
    			$shipper.='Miss.Zhang ';
    			$shipper.='0571-87834076';
    			//上海仓
    		}elseif ($order->department_id==7){
    			$consignor.="Far's warehouse in Shanghai";
    			$shipper.='No. 12, Jinshun Road, Zhuqiao Town, Pudong New Area, Shanghai,China 201323 ';
    			$shipper.='Mr.Gu ';
    			$shipper.='021-58590952';
    			//义乌仓
    		}elseif ($order->department_id==8){
    			$consignor.="Far's warehouse in Yiwu";
    			$shipper.='No.675-2 Airport Road, Yiwu City, Zhejiang Province,China 322000 ';
    			$shipper.='Mr.Yang ';
    			$shipper.='0579-85119351';
    			//广州仓
    		}elseif ($order->department_id==22){
            	$consignor.="Far's warehouse in Guangzhou";
            	$shipper.='No.7-10, Heming Business Building, Baiyun Third Line, Helong Street, Baiyun District, Guangzhou City, Guangdong Province,China 510080 ';
            	$shipper.='Miss.Li ';
            	$shipper.='020-36301839';
            	//青岛仓
            }elseif ($order->department_id==23){
            	$consignor.="Far's warehouse in Qingdao";
            	$shipper.='No.4 Reservoir Area, Shanhang Logistics Park, No.31 Liangjiang Road, Chengyang District, Qingdao City, Shandong Province,China 266108 ';
            	$shipper.='Mr Wang ';
            	$shipper.='18661786160';
            	//深圳仓
            }elseif ($order->department_id==24){
            	$consignor.="FAR's warehouse in Shenzhen Longhua";
            	$shipper.='Unit 5,No.8 Non-bonded Warehouse, South China International Logistics Center,No.1 Mingkang Road,Minzhi Street,Longhua New District,Shenzhen City,China 518000 ';
            	$shipper.='Mr Wang ';
            	$shipper.='4000857988';
            }
    
    		$dir=Q::ini('upload_tmp_dir');
    		@Helper_Filesys::mkdirs($dir);
    		$barcode=$dir.DS.$order->order_id.'.barcode.png';
    		$logo=$dir.DS.'logo.png';
    		$source=trim(file_get_contents('http://kuaijian.far800.com/public/barcode/html/image.php?filetype=PNG&dpi=90&scale=20&rotation=0&font_family=0&font_size=0&thickness=70&start=C&code=BCGcode128&text='.$order->far_no));
    		file_put_contents($barcode, $source);
    		$pdf=new PDF_Chinese('L','mm','far');
    		$pdf->AddGBFont('simhei', '黑体');
    		$pdf->AddPage();
    		$pdf->SetFont('Arial','B',12);
    		//阿里单号
    		$pdf->Cell(84,6,'Order No. :'.$order->ali_order_no,'1');
    		$pdf->Cell(66,6,'','TR');
    		$pdf->Ln();
    		$pdf->Cell(84,20,'','1','','C');
    		//泛远单号条形码
    		$pdf->Image($barcode,'12','19','80','14');
    		//泛远logo
    		$pdf->Image($logo,'95','15','63','20');
    		$pdf->Cell(66,20,'','R');
    		$pdf->Ln();
    		//泛远单号
    		$pdf->Cell(84,6,$order->far_no,'1','','C');
    		$pdf->SetFont('Arial','B',10);
    		//产品
    		$pdf->Cell(66,6,$order->service_code,'RB','','C');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',12);
    		//仓库名称
    		$pdf->Cell(150,8,$consignor,'1');
    		$pdf->Ln();
    		//发件人相关信息
    		$pdf->MultiCell(150,8,$shipper,'1');
    		//收件人姓名
    		$pdf->MultiCell(150,6,'To Consignee: '.$order->consignee_name1.' '.$order->consignee_name2,'1');
    		$pdf->SetFont('Arial','B',12);
    		//收件人地址1
    		$pdf->MultiCell(150,8,'Street Address1: '.$order->consignee_street1,'1');
    		//收件人地址2
    		$pdf->MultiCell(150,8,'Street Address2: '.$order->consignee_street2,'1');
    		//收件人城市和邮编
    		$pdf->Cell(99,8,'City&PostCode: '.$order->consignee_city.' '.$order->consignee_postal_code,'1');
    		$pdf->SetFont('Arial','B',10);
    		//收件人行政区/州
    		$pdf->Cell(51,8,'State: '.$order->consignee_state_region_code,'1');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',11);
    		//收件人电话
    		$pdf->Cell(99,8,'Contact Phone: '.$order->consignee_mobile,'1');
    		//收件人国家
    		$pdf->Cell(51,8,'Country: '.$order->consignee_country_code,'1');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',12);
    		$pdf->Cell(150,8,'SHIPMENT INFORMATION:','1','','C');
    		$pdf->Ln();
    		$pdf->Cell(99,7,'Main Products List','1','','C');
    		$pdf->SetFont('Arial','B',10);
    		$pdf->Cell(14,7,'Amount','1','','C');
    		$pdf->Cell(20,7,'Price/Unit','1','','C');
    		$pdf->Cell(17,7,'Subtotal','1','','C');
    		foreach ($invoice['items'] as $in){
    			$pdf->Ln();
    			$pdf->SetFont('simhei','',9);
    			//FAR中文品名FAR英文品名FAR HS编码
    			$pdf->Cell(99,6,iconv("utf-8","gbk",$in['prdoduct_name_hs']),'1','','L');
    			$pdf->SetFont('Arial','B',11);
    			//产品数量
    			$pdf->Cell(14,6,$in['quantity'],'1','','C');
    			//单价
    			$pdf->Cell(20,6,$in['price'],'1','','C');
    			//总价
    			$pdf->Cell(17,6,$in['itotal'],'1','','C');
    		}
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',11);
    		$pdf->Cell(99,6,'','1');
    		$pdf->Cell(34,6,'Total Value(USD):','1','','C');
    		//产品总价
    		$pdf->Cell(17,6,$total_value,'1','','C');
    		$pdf->Ln();
    		$pdf->SetFont('Arial','B',14);
    		$pdf->Cell(99,8,'Total packages','1','','C');
    		$pdf->Cell(51,8,'Total Weight(KG):','1','','C');
    		$pdf->Ln();
    		//包裹件数
    		$pdf->Cell(99,8,$toal_package,'1','','C');
    		//包裹重
    		$pdf->Cell(51,8,$total_weight,'1','','C');
    		$pdf->Ln();
    		$pdf->Cell(150,8,'Shipping Charges Payment Term: Prepaid&DDU','1');
    		$pdf->Ln();
    		$pdf->MultiCell(150,7,'Declaration Statement:I hereby certify that the information of this invoice is truce and correct and the contents and value of this shipment is as stated above.','1','L');
    		$alilabel=$dir.DS.$order->order_id.'.pdf';
    		$pdf->Output($alilabel,'F');
    		$pdf->Close();
    		exec("/usr/bin/convert -density 300 -depth 8 -quality 85 {$alilabel} -append {$alilabel}.jpg");
    		$recordformdata=file_get_contents($alilabel.'.jpg');
    		//uploadRecordFormDTO数据
    		$array=array(
    			'aliOrderNo'=>$order->ali_order_no,
    			'recordFormType'=>'farLabel',
    			'recordFormData'=>base64_encode($recordformdata)
    		);
    		$url_sign='http://112.124.134.6:80/openapi/param2/1/ali.intl.onetouch/logistics.order.uploadRecordForm/831170';
    		$ali=new Helper_ALI();
    		$secretKey='fq6nVNy02u';
    		$urlpath=strstr($url_sign, 'param2/');
    		$s=$urlpath.'uploadRecordForm'.'DTO'.json_encode($array);
    		$sign=strtoupper(bin2hex(hash_hmac('sha1',$s,$secretKey,true)));
    		$post_data='uploadRecordFormDTO='.urlencode(json_encode($array)).'&_aop_signature='.$sign;
    		//通过curl post 方式发送至阿里x-www-form-urlencoded 方式发送
    		$response=Helper_Curl::post($url_sign, $post_data,array(
    			'Content-Type:application/x-www-form-urlencoded'
    		));
    		QLog::log('ali_form_response:'.$response);
    		$response=json_decode($response,true);
    		if(isset($response['success']) && $response['success']==true){
    			
    		}else{
    			$order->send_ali_form_error=$response['message'];
    			$order->save();
    		}
    	}
    	exit();
    }
}
