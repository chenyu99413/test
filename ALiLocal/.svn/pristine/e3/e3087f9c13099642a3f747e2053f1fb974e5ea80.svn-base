<?PHP $this->_extends('_layouts/default_layout'); ?>
<?PHP $this->_block('title');?>
    订单轨迹
<?PHP $this->_endblock();?>
<?PHP $this->_block('head');?>
    <style type="text/css">
        .table>tbody>tr>td{
            border:0px;
        }
    </style>
<?PHP $this->_endblock();?>
<?PHP $this->_block('contents');?>
<?php
	echo Q::control ( 'path', '', array (
		'path' => array (
			'业务管理' => '',
			'订单查询' => url ( 'order/search' ),
			'订单轨迹' => ''
		) 
	) );
?>
<p style="clear: both;color:red">阿里单号：<?php echo $order->ali_order_no?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;泛远单号：<?php echo $order->far_no?></p>
<form method="POST" onsubmit=" return checktime();">
	<div class="FarSearch" >
		<table>
			<tbody>
				<tr>
				    <th class="required-title">轨迹代码</th>
					<td>
						<?php
						echo Q::control ( "dropdownbox", "tracking_code", array (
							"items" => $trace_code,
						    "value" => request ( "tracking_code" ),
							"style" => "width:200px" ,
						    "empty"=>true,
						    "required"=>'required'
						) )?>
					</td>
					<th class="required-title">轨迹时间</th>
					<td>
						<input class="easyui-datetimebox"
						name="trace_time"
						value="<?php echo Helper_Util::strDate ( "Y-m-d H:i:s", request('trace_time') )?>"
						style="width: 150px"/>
					</td>
					<th class="required-title">地点</th>
					<td>
						<input name="location" type="text" style="width: 100px"
							value="<?php echo request('location')?>">
					</td>
					<th class="required-title">中文描述信息</th>
					<td>
						<input name="trace_desc_cn" type="text" style="width: 120px" required="required"
							value="<?php echo request('trace_desc_cn')?>">
					</td>
					<th class="required-title">时区号</th>
					<td>
						<input  required="required" style="width: 80px;" type="text" maxlength="32" name="timezone" />
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="offset5 span2">
	   <button class="btn btn-small btn-success" id="search">
                                保存
       </button>
	</div>
	<h4 style="clear: both;"> 订单轨迹信息<font color="red">(例如：西一区录入-1，东一区，录入1)</font></h4>
	<table class="FarTable">
		<thead>
			<tr>
				<th class="span3">轨迹代码</th>
				<th class="span2">轨迹时间</th>
				<th class="span2">地点</th>
				<th>中文描述信息</th>
				<th style="width:80px;">时区</th>
				<th style="width:120px;">操作</th>
			</tr>
		</thead>
		<tbody>
		<?php foreach ($list as $temp):?>
			<tr>
				<td><?php echo $temp->tracking_code?></td>
				<td><?php echo Helper_Util::strDate('Y-m-d H:i:s', $temp->trace_time)?></td>
				<td><?php echo $temp->location?></td>
				<td><?php echo $temp->trace_desc_cn?></td>
				<td><?php echo $temp->timezone?></td>
				<td>
					<?php if ($temp->confirm_flag !='1'):?>
					<a class="btn btn-mini btn-info" onclick="tracedetail(this)" data='<?php echo $temp->tracking_id?>' href="javascript:void(0)">
						<i class="icon-edit"></i>
						编辑
					</a>
					<a class="btn btn-mini btn-info" href="<?php echo url('/confirm',array('tracking_id'=>$temp->tracking_id,'code'=>'trace'))?>">
						<i class="icon-ok"></i>
						确认
					</a>
					<?php endif;?>
				</td>
			</tr>
		<?php endforeach;?>
		</tbody>
	</table>
	<input type="hidden" name="order_id" value="<?php echo $order->order_id?>">
</form>  
<div id="window" class="easyui-window" title="轨迹编辑" data-options="modal:true,closed:true" style="width:800px;height:150px;padding:10px;">
    <form method="post" action="<?php echo url('order/tracedetail')?>">
        <table>
            <tr>
                <th class="required-title">轨迹时间</th>
					<td>
						<input class="easyui-datetimebox"
						name="edit_trace_time"
						id="edit_trace_time"
						value=""
						style="width: 150px"/>
					</td>
					<th class="required-title">地点</th>
					<td>
						<input name="location" id="location" type="text" style="width: 100px"
							value="">
					</td>
					<th class="required-title">中文描述信息</th>
					<td>
						<input name="trace_desc_cn" id="trace_desc_cn" type="text" style="width: 120px" required="required"
							value="">
					</td>
					<th class="required-title">时区号</th>
					<td>
						<input  required="required" id="timezone" style="width: 80px;" type="text" maxlength="32" name="timezone" />
					</td>
            </tr>
        </table>
        <div class="FarTool text-center" style="margin-top:30px;margin-right:60px;">
    		<button class="btn btn-primary btn-small" type="submit">
    			<i class="icon-save"></i>
    			保存
    		</button>
	    </div>
	<input type="hidden" name="tracking_id" value='' id="tracking_id">
    </form>
</div>
<?PHP $this->_endblock();?>
<script type="text/javascript">
//检查时间是否填写
function checktime(){
	var time =$('.textbox-value').val();
	if(time.length<1){
		$.messager.alert('Error','请填写轨迹时间');
		return false;
	}else{
		return true;
	}
}
//轨迹编辑
function tracedetail(obj){
	var tracking_id=$(obj).attr('data');
	$.ajax({
		url:'<?php echo url('/gettrace')?>',
		data:{tracking_id:tracking_id},
		type:'post',
		dataType:'json',
		success:function(data){
			var date=new Date(parseInt(data.trace_time) * 1000);
			var year = date.getFullYear(),
			month = date.getMonth() + 1,
			day = date.getDate(),
			hour = date.getHours(),
			minute = date.getMinutes(),
			second = date.getSeconds();
			if(second<10){
				second='0'+second;
			}
			$('#window').window({
			    title:data.tracking_code,
			});
			//写入窗口信息
			$('#edit_trace_time').datetimebox('setValue',year + "-" + month + "-" + day + " " + hour + ":" + minute + ":" + second);//设值
			$('#location').val(data.location);
			$('#trace_desc_cn').val(data.trace_desc_cn);
			$('#timezone').val(data.timezone);
			$('#tracking_id').val(data.tracking_id);
			$('#window').window('open');
		}
	});
	
}
</script>
